name: Deploy to Staging

on:
    push:
        branches:
            - staging

jobs:
    ftp-deploy:
        runs-on: ubuntu-latest
        environment: staging
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy Root Files
              uses: SamKirkland/FTP-Deploy-Action@v4.3.5
              with:
                  server: ${{ secrets.FTP_HOST }}
                  port: ${{ secrets.FTP_PORT }}
                  protocol: ${{ secrets.FTP_PROTOCOL }}
                  username: ${{ secrets.FTP_USER }}
                  password: ${{ secrets.FTP_PASSWORD }}
                  local-dir: ./
                  server-dir: ${{ secrets.FTP_SERVER_DIR }}
                  timeout: 60000
                  security: strict
                  exclude: |
                      wp-content/**
                      .git/**
                      .github/**
                      node_modules/**
                      vendor/**

            - name: Deploy Theme
              uses: SamKirkland/FTP-Deploy-Action@v4.3.5
              with:
                  server: ${{ secrets.FTP_HOST }}
                  port: ${{ secrets.FTP_PORT }}
                  protocol: ${{ secrets.FTP_PROTOCOL }}
                  username: ${{ secrets.FTP_USER }}
                  password: ${{ secrets.FTP_PASSWORD }}
                  local-dir: wp-content/themes/theme-fse/
                  server-dir: ${{ secrets.FTP_SERVER_DIR }}/wp-content/themes/theme-fse/
                  timeout: 60000
                  security: strict

            - name: Deploy Plugins
              uses: SamKirkland/FTP-Deploy-Action@v4.3.5
              with:
                  server: ${{ secrets.FTP_HOST }}
                  port: ${{ secrets.FTP_PORT }}
                  protocol: ${{ secrets.FTP_PROTOCOL }}
                  username: ${{ secrets.FTP_USER }}
                  password: ${{ secrets.FTP_PASSWORD }}
                  local-dir: wp-content/plugins/
                  server-dir: ${{ secrets.FTP_SERVER_DIR }}/wp-content/plugins/
                  timeout: 60000
                  security: strict
                  exclude: |
                      node_modules/**
                      vendor/**
                      *.log
                      .DS_Store
                      Thumbs.db
                      *.sql

            # Post-deployment health check
            - name: Health Check
              if: success()
              run: |
                  echo "üè• Performing health check..."
                  if [ -n "${{ vars.STAGING_URL }}" ]; then
                      response=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.STAGING_URL }}" || echo "000")
                      if [ "$response" = "200" ]; then
                          echo "‚úÖ Health check passed - Site is responding (HTTP $response)"
                      else
                          echo "‚ö†Ô∏è Health check warning - Site returned HTTP $response"
                      fi
                  else
                      echo "‚ö†Ô∏è No staging URL configured for health check"
                  fi

            # Deployment summary
            - name: Deployment Summary
              if: always()
              run: |
                  echo "üìä Deployment Summary"
                  echo "=================="
                  echo "Environment: ${{ env.DEPLOYMENT_ENVIRONMENT }}"
                  echo "Status: ${{ job.status }}"
                  echo "Commit: ${{ steps.deploy-info.outputs.commit_short }}"
                  echo "Branch: ${{ steps.deploy-info.outputs.branch }}"
                  echo "Triggered by: ${{ github.actor }}"
                  echo "Started: ${{ steps.deploy-info.outputs.timestamp }}"
                  echo "Completed: $(date -u +%Y%m%d-%H%M%S)"

                  if [ "${{ job.status }}" = "success" ]; then
                      echo "‚úÖ Staging deployment completed successfully!"
                      if [ -n "${{ vars.STAGING_URL }}" ]; then
                          echo "üåê Site URL: ${{ vars.STAGING_URL }}"
                      fi
                  else
                      echo "‚ùå Staging deployment failed!"
                      echo "Check the logs above for detailed error information."
                  fi
